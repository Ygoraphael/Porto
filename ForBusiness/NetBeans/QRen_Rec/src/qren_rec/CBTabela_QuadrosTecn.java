package fme;

import java.io.PrintStream;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.Vector;
import javax.swing.JScrollPane;
import javax.swing.JTable;




























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































class CBTabela_QuadrosTecn
  extends CBTabela
{
  public String getPagina()
  {
    return "QuadrosTecn";
  }
  
  public SteppedComboBox cboEstabs = null;
  
  Frame_QuadrosTecn_2 P_2;
  
  boolean col_tip = CParseConfig.hconfig.get("tipologia2").toString().equals("Q");
  
  CBTabela_QuadrosTecn() {
    tag = "QuadrosTecn";
    
    P_2 = ((Frame_QuadrosTecn_2)fmeApp.Paginas.getPage("QuadrosTecn_2"));
    if (P_2 == null) { return;
    }
    cols = new CHTabColModel[13];
    cols[0] = new CHTabColModel("n_ordem", "Nº", true, false, true, CFLib.VLD_INT);
    cols[1] = new CHTabColModel("area", "Área Funcional (id)", true, true, false, null);
    cols[2] = new CHTabColModel("area_d", "Área<br>Funcional", false, true, true, null);
    cols[3] = new CHTabColModel("area_form", "Área de Formação", true, true, true, null);
    cols[4] = new CHTabColModel("tipologia", "Tipologia da Operação (id)", true, true, false, null);
    cols[5] = new CHTabColModel("tipologia_d", "Tipologia da Operação", false, true, col_tip, null);
    cols[6] = new CHTabColModel("habilit", "Nível (id)", true, true, false, null);
    cols[7] = new CHTabColModel("habilit_d", "Nível de<br>Qualific.", false, true, true, null);
    cols[8] = new CHTabColModel("data", "Data prev.<br>contratação", true, true, true, CFLib.VLD_DATA);
    cols[9] = new CHTabColModel("n_meses", "Duração<br>(meses)", true, true, true, CFLib.VLD_INT);
    cols[10] = new CHTabColModel("estab", "Estab.", true, true, true, null);
    cols[11] = new CHTabColModel("remuneracao", "Remuneração<br>(mensal)", true, true, true, CFLib.VLD_VALOR);
    cols[12] = new CHTabColModel("taxa_segs", "Taxa de<br>Segurança<br>Social", true, true, true, CFLib.VLD_PERC_0);
    
    init_dados(6);
    
    init_handler(P_2.getJTable_QuadrosTecn_1());
    P_2.getJTable_QuadrosTecn_1().addKeyListener(new TableKeyListener(this));
    handler.width = P_2.getJScrollPane_QuadrosTecn_1().getWidth();
    
    handler.set_col_text(0, 0.04D, "C");
    handler.set_col_comboS(2, 0.15D, null, CTabelas.AreasFunc, 1, 220);
    handler.set_col_text(3, 0.3D, null);
    if (col_tip)
      handler.set_col_comboS(5, 0.25D, null, CTabelas.TipoProj, 1, 350);
    handler.set_col_comboS(7, 0.085D, null, CTabelas.NiveisQual, 1, 60);
    handler.set_col_text(8, 0.1D, "C");
    handler.set_col_text(9, 0.08D, "R");
    cboEstabs = handler.set_col_comboFD(10, 0.075D, "C", CTabelas.EstabsF1, 1, 200);
    handler.set_col_text(11, 0.13D, "R");
    handler.set_col_text(12, 0.09D, "R");
    
    started = true;
  }
  
  void on_update(String colname, int nRow, String v)
  {
    numerar(0);
    if (colname.equals("habilit_d")) {
      String habilit = "";
      if (v.length() > 0)
        habilit = CTabelas.NiveisQual.lookup(1, v, 0);
      setColValue("habilit", nRow, habilit);
    }
    if (colname.equals("habilit")) {
      String habilit_d = "";
      if (v.length() > 0)
        habilit_d = CTabelas.NiveisQual.lookup(0, v, 1);
      setColValue("habilit_d", nRow, habilit_d);
    }
    if (colname.equals("area_d")) {
      String area = "";
      if (v.length() > 0) area = CTabelas.AreasFunc.lookup(1, v, 0);
      setColValue("area", nRow, area);
    }
    if (colname.equals("area")) {
      String area_d = "";
      if (v.length() > 0) area_d = CTabelas.AreasFunc.lookup(0, v, 1);
      setColValue("area_d", nRow, area_d);
    }
    if ((colname.equals("estab")) && 
      (v.length() > 0)) { CTabelas.EstabsF1.set_filter(3, "0");
    }
    if (colname.equals("tipologia_d")) {
      String tipologia = "";
      if (v.length() > 0) tipologia = CTabelas.TipoProj.lookup(1, v, 0);
      setColValue("tipologia", nRow, tipologia);
    }
    if (colname.equals("tipologia")) {
      String tipologia_d = "";
      if (v.length() > 0) tipologia_d = CTabelas.TipoProj.lookup(0, v, 1);
      setColValue("tipologia_d", nRow, tipologia_d);
    }
    handler.j.repaint();
  }
  
  void _filter_populate_estabs(SteppedComboBox cboEstabs, int row) {
    String estabs = getColValue("estab", row);
    CTabelas.EstabsF1.set_filter(3, "0");
    CTabelas.EstabsF1._populateComboBox(cboEstabs, 0);
    if (estabs.length() > 0) {
      int n = CTabelas.EstabsF1.getIndexFromCode(estabs);
      if (n >= 0) cboEstabs.setSelectedIndex(n + 1);
    }
  }
  
  String on_xml(String tag, int row, String v) {
    String s = "";
    if (tag.equals("habilit"))
      s = s + _lib.xml_encode("habilit_d", getColValue("habilit_d", row));
    if (tag.equals("area"))
      s = s + _lib.xml_encode("area_d", getColValue("area_d", row));
    if (tag.equals("tipologia"))
      s = s + _lib.xml_encode("tipologia_d", getColValue("tipologia_d", row));
    return s;
  }
  
  CHValid_Grp validar(CHValid_Grp err_list) {
    handler.__garbage_stop_editing();
    if (err_list == null) {
      err_list = new CHValid_Grp(this, "Contratação de quadros técnicos");
    }
    boolean qinv = false;
    
    for (int i = 0; i < QInvdados.size(); i++) {
      if (CBData.QInv.getColValue("classe", i).equals("130")) {
        qinv = true;
        break;
      }
    }
    
    if ((isEmpty()) && (qinv)) {
      err_list.add_msg(new CHValid_Msg("quadros", "Lista vazia"));
    }
    for (int i = 0; i < dados.size(); i++) {
      StringBuffer mask = new StringBuffer("R-RR---RRRRRR");
      if (col_tip) { mask.setCharAt(getColIndex("tipologia_d"), 'R');
      }
      TabError[] e = isIncompletAll(i, mask.toString());
      for (int ii = 0; (e != null) && (ii < e.length); ii++) {
        err_list.add_msg(new CHValid_Msg("incomplet", e[ii].msg("Linha %L incompleta: %T - %o")));
      }
      if (!getColValue("area_d", i).equals("")) {
        System.out.println("turismo = " + CBData.turismo);
        String area = getColValue("area", i);
        if ((_lib.to_double(CBData.turismo) > 50.0D) && (area.startsWith("1")))
          err_list.add_msg(new CHValid_Msg("qtecnicos", "Linha " + (i + 1) + ": Área Funcional inválida"));
        if ((_lib.to_double(CBData.turismo) <= 50.0D) && (area.startsWith("2")))
          err_list.add_msg(new CHValid_Msg("qtecnicos", "Linha " + (i + 1) + ": Área Funcional inválida"));
      }
      if ((!getColValue("data", i).equals("")) && (!getColValue("n_meses", i).equals("")) && 
        (!DadosProjectogetByName"dt_fim"v.equals("")) && (!DadosProjectogetByName"dt_inicio"v.equals(""))) {
        String dt_inicio = getColValue("data", i);String n_meses = getColValue("n_meses", i);
        int n_meses_int = _lib.to_int(n_meses);
        Date dt_i = CFType_Data.parse_date(dt_inicio);
        Calendar c = Calendar.getInstance();
        c.setTime(dt_i);
        c.add(2, n_meses_int);
        c.add(6, -1);
        String dt_f = new SimpleDateFormat("yyyy-MM-dd").format(c.getTime());
        Date dt_fim_calc = c.getTime();
        
        Date dt_ini = CFType_Data.parse_date(DadosProjectogetByName"dt_inicio"v);
        Date dt_fim = CFType_Data.parse_date(DadosProjectogetByName"dt_fim"v);
        
        if ((dt_ini != null) && (dt_i != null) && (dt_i.before(dt_ini))) {
          err_list.add_msg(new CHValid_Msg("dt_inicio", 
            "Linha " + (i + 1) + ": Data de prevista de contratação não pode ser anterior à Data de Início do Projeto"));
        }
        if ((dt_fim_calc != null) && (dt_fim != null) && (dt_fim.before(dt_fim_calc))) {
          err_list.add_msg(new CHValid_Msg("dt_inicio", 
            "Linha " + (i + 1) + ": Data de prevista de contratação + Duração (meses) não pode ser posterior à Data de Fim do Projeto"));
        }
      }
      
      if (col_tip) {
        String tip = getColValue("tipologia", i);
        boolean tip_selected = false;
        if (!tip.equals("")) {
          for (int ii = 0; ii < Tipologiadados.size(); ii++) {
            if (tip.equals(CBData.Tipologia.getColValue("tipologia", ii))) {
              if (!CBData.Tipologia.getColValue("select", ii).equals("S")) break;
              tip_selected = true;
              
              break;
            }
          }
        } else {
          tip_selected = true;
        }
        if (!tip_selected)
          err_list.add_msg(new CHValid_Msg("tipologia", 
            "Linha " + (i + 1) + ": Tipologia de Operação não selecionada na página de Dados do Projeto"));
      }
    }
    return err_list;
  }
}
