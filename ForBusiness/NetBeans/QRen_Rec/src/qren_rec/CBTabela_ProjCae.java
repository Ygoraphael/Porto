package fme;

import java.util.HashMap;
import java.util.Vector;
import javax.swing.JScrollPane;






























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































class CBTabela_ProjCae
  extends CBTabela
{
  Frame_Proj_1 P07;
  
  public String getPagina()
  {
    return "Proj_1";
  }
  

  CBTabela_ProjCae()
  {
    P07 = ((Frame_Proj_1)fmeApp.Paginas.getPage("Proj_1"));
    if (P07 == null) return;
    started = true;
    
    tag = "ProjCae";
    
    cols = new CHTabColModel[3];
    cols[0] = new CHTabColModel("cae", "CAE", true, true, true, null);
    cols[1] = new CHTabColModel("cae_d", "Designação", false, false, true, null);
    cols[2] = new CHTabColModel("perc", "%", true, true, true, CFLib.VLD_PERC);
    
    init_dados(4);
    

    init_handler(P07.getJTable_CAE());
    P07.getJTable_CAE().addKeyListener(new TableKeyListener(this));
    handler.width = (P07.getJScrollPane_CAE().getWidth() - 2);
    
    handler.set_col_comboD(0, 0.2D, null, CTabelas.Cae, 0, 450);
    handler.set_col(1, 0.7D, null);
    handler.set_col_text(2, 0.1D, "R");
  }
  
  void on_update(String tag, int row, String v)
  {
    if (tag.equals("cae")) {
      String design = "";
      if (v.length() > 0) design = CTabelas.Cae.lookup(0, v, 1);
      setColValue("cae_d", row, design);
      if (row == 0) {
        CBData.cae = v;
      }
    }
    
    if ((tag.equals("cae")) || (tag.equals("perc"))) {
      upd_caes();
    }
  }
  
  void upd_caes() {
    double turismo = 0.0D;
    
    String lista_turismo = "55.*|561.*|563.*|771.*|79.*|77210|82300|90.*|91.*|93110|93192|93210|93292|93293|93294|96040";
    
    for (int i = 0; i < dados.size(); i++) {
      String cae = getColValue("cae", i);
      if ((!cae.equals("")) && 
        (cae.matches(lista_turismo))) {
        turismo += _lib.to_double(getColValue("perc", i));
      }
    }
    CBData.turismo = turismo > 0.0D ? _lib.to_string(turismo) : "0";
  }
  
  CHValid_Grp validar(CHValid_Grp err_list) {
    if (err_list == null) {
      err_list = new CHValid_Grp(this, "Atividade(s) Económica(s) do Projeto");
    }
    if (!isUnique("cae")) {
      err_list.add_msg(new CHValid_Msg("unique", "Não podem existir CAE's repetidas"));
    }
    



    if (isEmpty()) {
      err_list.add_msg(new CHValid_Msg("100%", "Deve indicar a(s) CAE(s) onde o projeto tem impacto"));
    } else if (_lib.round(getSum("perc")) != 100.0D) {
      err_list.add_msg(new CHValid_Msg("100%", "Deve indicar a(s) CAE(s) correspondente(s) a 100% da atividade"));
    }
    double v = 0.0D;
    double v_anterior = 0.0D;
    

    int nRows = dados.size();
    
    String n_cae_proj = "";
    if (CParseConfig.hconfig.get("n_cae_proj") != null)
      n_cae_proj = (String)CParseConfig.hconfig.get("n_cae_proj");
    String cae_proj = "";
    if (CParseConfig.hconfig.get("cae_proj") != null) {
      cae_proj = (String)CParseConfig.hconfig.get("cae_proj");
    }
    String cae_prom = "";
    for (int i = 0; i < PromCaedados.size(); i++) {
      if ((!CBData.PromCae.getColValue("cae", i).equals("")) && (!CBData.PromCae.getColValue("perc_pos", i).equals("")) && 
        (_lib.to_double(CBData.PromCae.getColValue("perc_pos", i)) != 0.0D)) { cae_prom = cae_prom + CBData.PromCae.getColValue("cae", i) + "|";
      }
    }
    if (cae_prom.length() > 0) { cae_prom = cae_prom.substring(0, cae_prom.length() - 1);
    }
    for (i = 0; i < nRows; i++)
    {
      StringBuffer mask = new StringBuffer("R-R");
      TabError[] e = isIncompletAll(i, mask.toString());
      for (int ii = 0; (e != null) && (ii < e.length); ii++) {
        err_list.add_msg(new CHValid_Msg("incomplet", e[ii].msg("Linha %L incompleta: %T - %o")));
      }
      String cae = getColValue("cae", i);
      if (cae.length() != 0) {
        if (cae_proj.length() > 0) {
          if (cae.matches(cae_proj)) {
            if ((n_cae_proj.length() > 0) && 
              (cae.matches(n_cae_proj))) {
              err_list.add_msg(new CHValid_Msg("100%", 'W', "Linha " + (i + 1) + ": " + cae + " - atividade económica não enquadrável"));
            }
          } else {
            err_list.add_msg(new CHValid_Msg("100%", 'W', "Linha " + (i + 1) + ": " + cae + " - atividade económica não enquadrável"));
          }
        }
        else if ((n_cae_proj.length() > 0) && 
          (cae.matches(n_cae_proj))) {
          err_list.add_msg(new CHValid_Msg("100%", 'W', "Linha " + (i + 1) + ": " + cae + " - atividade económica não enquadrável"));
        }
        




        String s = ((String[])dados.elementAt(i))[getColIndex("perc")];
        
        if (s.length() > 0) {
          v = Double.parseDouble(s);
          if (i == 0) {
            v_anterior = v;
          }
          else {
            if (_lib.round(v) > _lib.round(v_anterior)) {
              err_list.add_msg(new CHValid_Msg("ordem", 
                "Deve indicar as CAE's por ordem decrescente de % (" + _lib.to_format(v_anterior) + " < " + _lib.to_format(v) + ")"));
              break;
            }
            v_anterior = v;
          }
        }
        else if (!cae.matches(cae_prom)) {
          err_list.add_msg(new CHValid_Msg("100%", 'W', "Linha " + (i + 1) + ": " + cae + " - CAE não prevista no pós-projeto – Página 3 – Caracterização do Beneficiário – Quadro “Atividades Económica do Beneficiário”"));
        } } }
    return err_list;
  }
  
  String on_xml(String tag, int row, String v) {
    String s = "";
    if (tag.equals("cae"))
      s = s + _lib.xml_encode("cae_d", getColValue("cae_d", row));
    return s;
  }
}
